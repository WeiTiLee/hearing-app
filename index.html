<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聽力診斷計算機</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .app-container {
            @apply max-w-lg w-full p-4 sm:p-8 space-y-6 bg-white dark:bg-gray-800 rounded-3xl shadow-2xl;
        }
        .input-grid {
            @apply grid grid-cols-4 gap-4 justify-items-center;
        }
        .number-input-container {
            @apply flex justify-center;
        }
        .number-input {
            @apply text-center text-2xl sm:text-3xl p-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-transparent transition-colors w-20;
            color: #1f2937; /* Explicitly set text color */
        }
        .dark .number-input {
            color: #e5e7eb; /* Explicitly set text color for dark mode */
        }
        .keypad-button {
            @apply flex items-center justify-center p-4 sm:p-5 text-2xl sm:text-3xl font-bold rounded-2xl shadow-md transition-transform transform hover:scale-105 active:bg-gray-200 active:shadow-inner;
            aspect-ratio: 1 / 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

    <div class="app-container">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-900 dark:text-white">聽力診斷計算機</h1>
        
        <!-- 輸入區域 -->
        <div class="input-section space-y-4">
            <!-- 左耳輸入 -->
            <div class="ear-input-group">
                <label for="left-ear-1" class="block text-lg font-semibold text-center mb-2">左耳</label>
                <div class="input-grid">
                    <input type="text" id="left-ear-1" class="number-input" placeholder="" maxlength="3" readonly data-ear="left">
                    <input type="text" id="left-ear-2" class="number-input" placeholder="" maxlength="3" readonly data-ear="left">
                    <input type="text" id="left-ear-3" class="number-input" placeholder="" maxlength="3" readonly data-ear="left">
                    <input type="text" id="left-ear-4" class="number-input" placeholder="" maxlength="3" readonly data-ear="left">
                </div>
            </div>
            
            <!-- 右耳輸入 -->
            <div class="ear-input-group">
                <label for="right-ear-1" class="block text-lg font-semibold text-center mb-2">右耳</label>
                <div class="input-grid">
                    <input type="text" id="right-ear-1" class="number-input" placeholder="" maxlength="3" readonly data-ear="right">
                    <input type="text" id="right-ear-2" class="number-input" placeholder="" maxlength="3" readonly data-ear="right">
                    <input type="text" id="right-ear-3" class="number-input" placeholder="" maxlength="3" readonly data-ear="right">
                    <input type="text" id="right-ear-4" class="number-input" placeholder="" maxlength="3" readonly data-ear="right">
                </div>
            </div>
        </div>

        <!-- 鍵盤區域 -->
        <div class="keypad grid grid-cols-4 gap-2 sm:gap-4 p-4 bg-gray-200 dark:bg-gray-700 rounded-2xl shadow-inner">
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="1">1</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="2">2</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="3">3</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="4">4</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="5">5</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="6">6</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="7">7</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="8">8</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="0">0</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="9">9</button>
            <button class="keypad-button bg-gray-50 text-gray-800" data-value="00">00</button>
            <button class="keypad-button bg-gray-400 text-gray-800 hover:bg-gray-500 active:bg-gray-600" data-action="backspace">←</button>
            <button class="keypad-button bg-blue-500 text-white hover:bg-blue-600 active:bg-blue-700" data-action="next">→</button>
            <button class="keypad-button bg-green-500 text-white hover:bg-green-600 active:bg-green-700" data-action="diagnose">診斷</button>
            <button class="keypad-button bg-red-500 text-white hover:bg-red-600 active:bg-red-700" data-action="clear">清除</button>
        </div>

        <!-- 診斷結果區域 -->
        <div class="diagnosis-section mt-6">
            <h2 class="text-xl sm:text-2xl font-bold mb-2">診斷結果</h2>
            <div id="diagnosis-code" class="text-3xl font-extrabold text-center text-green-600 dark:text-green-400 p-2 sm:p-4 bg-gray-50 dark:bg-gray-800 rounded-xl mb-4">
                等待輸入...
            </div>
            <div id="diagnosis-description" class="text-base sm:text-lg text-gray-700 dark:text-gray-300">
                <p class="text-center">請輸入兩耳各四個聽力數字，然後點擊「診斷」按鈕。</p>
            </div>
        </div>
    </div>

    <!-- 訊息彈窗 -->
    <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl text-center max-w-xs w-full space-y-4">
            <p id="message-text" class="text-gray-900 dark:text-white font-semibold text-lg"></p>
            <button id="message-ok-btn" class="w-full bg-blue-500 text-white font-bold py-2 rounded-xl hover:bg-blue-600 transition-colors">確認</button>
        </div>
    </div>

    <script>
        const leftInputs = Array.from(document.querySelectorAll('#left-ear-1, #left-ear-2, #left-ear-3, #left-ear-4'));
        const rightInputs = Array.from(document.querySelectorAll('#right-ear-1, #right-ear-2, #right-ear-3, #right-ear-4'));
        const allInputs = [...leftInputs, ...rightInputs];
        const keypad = document.querySelector('.keypad');
        const diagnosisCodeEl = document.getElementById('diagnosis-code');
        const diagnosisDescriptionEl = document.getElementById('diagnosis-description');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        let activeInput = allInputs[0];
        
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        messageOkBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        function updateActiveInput() {
            allInputs.forEach(input => input.classList.remove('border-blue-500', 'ring-4'));
            if (activeInput) {
                activeInput.classList.add('border-blue-500', 'ring-4');
            }
        }

        allInputs.forEach(input => {
            input.addEventListener('click', () => {
                activeInput = input;
                updateActiveInput();
            });
        });

        // 初始化
        updateActiveInput();

        keypad.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            const value = button.dataset.value;

            if (action === 'clear') {
                allInputs.forEach(input => input.value = '');
                diagnosisCodeEl.textContent = '等待輸入...';
                diagnosisDescriptionEl.innerHTML = '<p class="text-center">請輸入兩耳各四個聽力數字，然後點擊「診斷」按鈕。</p>';
                activeInput = allInputs[0];
                updateActiveInput();
            } else if (action === 'backspace') {
                if (activeInput.value.length > 0) {
                    activeInput.value = activeInput.value.slice(0, -1);
                } else {
                    const currentIndex = allInputs.indexOf(activeInput);
                    if (currentIndex > 0) {
                        activeInput = allInputs[currentIndex - 1];
                        updateActiveInput();
                    }
                }
            } else if (action === 'next') {
                const currentIndex = allInputs.indexOf(activeInput);
                if (currentIndex < allInputs.length - 1) {
                    activeInput = allInputs[currentIndex + 1];
                    updateActiveInput();
                } else {
                    showMessage('所有輸入欄位都已填寫完畢。');
                }
            } else if (action === 'diagnose') {
                diagnose();
            } else if (value !== undefined) {
                if (activeInput.value.length < 3) {
                    activeInput.value += value;
                } else {
                    showMessage('數字不能超過三位數。');
                }
            }
        });

        function diagnose() {
            const leftNumbers = leftInputs.map(input => parseInt(input.value, 10));
            const rightNumbers = rightInputs.map(input => parseInt(input.value, 10));

            if (leftNumbers.some(isNaN) || rightNumbers.some(isNaN)) {
                showMessage('請輸入兩耳的所有八個數字。');
                return;
            }

            const totalSum = leftNumbers.reduce((sum, current) => sum + current, 0) + 
                             rightNumbers.reduce((sum, current) => sum + current, 0);

            let code = '';
            let description = '';
            let color = '';

            if (totalSum >= 1200) {
                code = '極重度聽損 (D4)';
                description = '綜合總數值超過1200，可能為極重度聽力損失，建議立即尋求專業醫療協助。';
                color = 'text-red-600 dark:text-red-400';
            } else if (totalSum >= 800) {
                code = '重度聽損 (D3)';
                description = '綜合總數值超過800，可能為重度聽力損失，請務必進行更詳細的聽力檢查。';
                color = 'text-orange-600 dark:text-orange-400';
            } else if (totalSum >= 400) {
                code = '中度聽損 (D2)';
                description = '綜合總數值超過400，可能為中度聽力損失，建議進行專業聽力檢查。';
                color = 'text-yellow-600 dark:text-yellow-400';
            } else if (totalSum >= 100) {
                code = '輕度聽損 (D1)';
                description = '綜合總數值超過100，可能為輕度聽力損失。';
                color = 'text-green-600 dark:text-green-400';
            } else {
                code = '聽力正常 (C0)';
                description = '綜合總數值小於100，聽力狀況可能正常，但建議定期檢查。';
                color = 'text-blue-600 dark:text-blue-400';
            }

            diagnosisCodeEl.textContent = code;
            diagnosisCodeEl.className = `text-3xl font-extrabold text-center p-2 sm:p-4 bg-gray-50 dark:bg-gray-800 rounded-xl mb-4 ${color}`;
            diagnosisDescriptionEl.innerHTML = `<p>${description}</p>`;
        }
    </script>

</body>
</html>
